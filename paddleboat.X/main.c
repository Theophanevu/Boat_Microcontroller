/*
 * File:   main.c
 * Author: Albert
 *
 * Created on 20 novembre 2018, 09:38
 */


#include <xc.h>
#include <string.h>
#include <stdio.h>
//#include <time.h>
#include "glcd.h"

#define ROCKS_NB 2
#define BOAT_POSX 16

#pragma config FOSC = HS 		//oscillator HS
#pragma config PWRT = OFF
#pragma config BOR = OFF
#pragma config WDT = OFF 		//Disable watchDog
#pragma config LVP = OFF 		//Disable low voltage programmig
#pragma config DEBUG = OFF		//Debug ON

const unsigned char fond[] = {
0x00, 0x03, 0x9F, 0xFF, 0xEF, 0xCF, 0x83, 0x01, 0x21, 0x61, 0x20, 0x00, 0x03, 0x81, 0xC1, 0xE1,
0x71, 0x30, 0xF8, 0x18, 0x0C, 0x08, 0x00, 0xC1, 0x03, 0x07, 0x9F, 0x9F, 0x3F, 0xFF, 0xFF, 0xFF,
0xCF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xC7, 0x8E, 0x1C, 0x1E, 0x1E, 0x18, 0x10, 0x00, 0x00,
0x00, 0x00, 0x00, 0xF8, 0xEC, 0xF9, 0x7F, 0x1F, 0x00, 0x80, 0xE3, 0x73, 0x1B, 0x19, 0x1B, 0x1B,
0x00, 0x00, 0x80, 0xC1, 0x7F, 0x3C, 0x00, 0x18, 0x1E, 0x07, 0x00, 0x20, 0x30, 0x38, 0x18, 0xCC,
0xCC, 0x43, 0x03, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0xC3, 0x61, 0x20, 0x00,
0x01, 0x03, 0xC7, 0x62, 0x60, 0x60, 0x00, 0x04, 0x06, 0x87, 0xFC, 0xF9, 0x81, 0x80, 0x86, 0x0E,
0x0C, 0x00, 0x00, 0x00, 0x03, 0x01, 0x10, 0x30, 0x70, 0x60, 0x08, 0x78, 0x7D, 0xFC, 0xFC, 0x9F,
0xF0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF4, 0xF0, 0xF0, 0xF0, 0xF2, 0xFF, 0xFF, 0xF0,
0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8, 0xF7, 0xF7, 0xF0, 0xFF, 0xFF, 0xFC, 0xFF, 0xFF, 0xFF,
0xFF, 0xFE, 0xFE, 0xFC, 0xFC, 0xF0, 0xF0, 0xF0, 0xF9, 0xF8, 0xF0, 0xF0, 0xF0, 0xF0, 0xF1, 0xFE,
0xF8, 0xF0, 0xF8, 0xFF, 0xFF, 0xF0, 0xF0, 0xF8, 0xF8, 0xF8, 0xFC, 0xFC, 0xFC, 0xF8, 0xF8, 0xFC,
0xFE, 0xFF, 0xFF, 0xFE, 0xFC, 0xF8, 0xF0, 0xF1, 0xF1, 0xF3, 0xF3, 0xF8, 0xFC, 0xFC, 0xF8, 0xF0,
0xF0, 0xF8, 0xFC, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xF8, 0xF8,
0xFC, 0xFC, 0xF4, 0xF4, 0xFE, 0xFE, 0xFC, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFB, 0xF9,
0xF8, 0xFF, 0xF6, 0xF6, 0xFC, 0xFC, 0xFC, 0xFE, 0xFF, 0xFE, 0xF8, 0xF8, 0xFC, 0xFF, 0xFF, 0xFF,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x4F, 0x9F, 0x3F, 0x3F, 0x1F, 0x0F, 0x0F, 0x0F, 0x8F, 0x6F, 0x1F, 0x1F, 0x0F, 0x0F, 0x0F, 0xCF,
0xEF, 0x6F, 0x4F, 0x0F, 0x1F, 0x1F, 0x0F, 0x0F, 0x8F, 0x3F, 0x7F, 0x8F, 0x0F, 0x0F, 0x0F, 0x1F,
0x1F, 0x0F, 0x0F, 0x8F, 0x8F, 0x0F, 0x2F, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x3F, 0x4F, 0x6F, 0x6F, 0x6F, 0x4F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
0x8F, 0xFF, 0x3F, 0x1F, 0x1F, 0xCF, 0xCF, 0xEF, 0xCF, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x9F, 0xCF,
0xCF, 0xFF, 0x6F, 0x6F, 0x0F, 0x0F, 0xCF, 0xCF, 0x6F, 0x3F, 0x1F, 0x0F, 0x0F, 0x8F, 0xCF, 0x0F,
0x0F, 0x0F, 0x0F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x0F, 0x0F, 0x0F, 0x0F,
0x2F, 0x0F, 0x0F, 0x8F, 0xCF, 0x8F, 0x8F, 0x8F, 0x9F, 0x3F, 0x6F, 0xCF, 0x8F, 0xCF, 0xEF, 0xEF,
0x00, 0x00, 0xC0, 0xF0, 0xF4, 0x9C, 0xFC, 0xFC, 0x7D, 0x78, 0x08, 0x60, 0x70, 0x30, 0x10, 0x01,
0x03, 0x00, 0x00, 0x00, 0x0C, 0x0E, 0x86, 0x80, 0x81, 0xF9, 0xFC, 0x87, 0x06, 0x04, 0x00, 0x60,
0x60, 0x62, 0xC7, 0x03, 0x01, 0x00, 0x20, 0x61, 0xC3, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x0F, 0x07, 0x03, 0x43, 0xCC, 0xCC, 0x18, 0x38, 0x30, 0x20, 0x00, 0x07, 0x1E, 0x18, 0x00, 0x3C,
0x7F, 0xC1, 0x80, 0x00, 0x00, 0x1B, 0x1B, 0x19, 0x1B, 0x73, 0xE3, 0x80, 0x00, 0x1F, 0x7F, 0xF9,
0xEC, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x18, 0x1E, 0x1E, 0x1C, 0x8E, 0xC7, 0x03, 0x00,
0x00, 0x00, 0x00, 0x00, 0xCF, 0xFF, 0xFF, 0xFF, 0x3F, 0x9F, 0x90, 0x00, 0x00, 0xC1, 0x00, 0x08,
0x0C, 0x18, 0xF8, 0x30, 0x71, 0xE1, 0xC1, 0x81, 0x03, 0x00, 0x20, 0x61, 0x21, 0x01, 0x83, 0xCF
};

typedef struct rock{
    signed char posX;
    unsigned char posY;
}t_rock;

typedef struct boat{
    //unsigned char posX;
    unsigned char posY;
    signed char angle; //-2 -1 0 1 2
}t_boat;

char up_key=0;
char down_key=0;

unsigned int nb=0;

// --- init the PIC18F device
void initMyPIC18F(void)
{
	// PORTA digital
	ADCON1 = 0x0F ;
	ADCON0 = 0;

	// set ports as OUTPUTS
	TRISB = 0x00;
	TRISC = 0x00;
	TRISD = 0x00;
	TRISE = 0x00;
    
    // set PORTA as input
    TRISA = 0xFF;

	// set port by port on "all zeros"
	PORTB = 0x00;
	PORTC = 0x00;
	PORTD = 0x00;

	PORTE = 0x00;

}

void wait(int val){
    int i, j;
    for(i=0;i<val;i++){
        for(j=0;j<10;j++){
            
        }
    }
}

t_rock initRock(){
    t_rock rock; 
    rock.posX=127;
    rock.posY=2+rand()%4;
    return rock;
}

void play(){
    //Declare variables
    unsigned char game_over, i;
    unsigned int score;
    t_boat boat;
    t_rock rocks[ROCKS_NB];
    char scorestr[20];
    
    //Initialize the boat
    boat.posY=31;
    boat.angle=0;
    
    //the rocks
    for(i=0; i<ROCKS_NB; i++){ 
        rocks[i]=initRock();
        rocks[i].posX=127-(ROCKS_NB-1-i)*(128/ROCKS_NB);
    }
    
    //and the game
    game_over=0;
    score=0;
    
    //Print background
    glcd_Image(fond);
    glcd_SetCursor(24,7);
    glcd_WriteString("SCORE", f8X8, 1);
    
    //Game loop
    while(!game_over)
    { 
        //Update command
        if(PORTAbits.RA0){
            boat.angle++;
            //up_key=0;
        }
        if(PORTAbits.RA1){
            boat.angle--;
            //down_key=0;
        }
        //Make sure command is allowed
        if(boat.angle>2){
            boat.angle=2;
        }
        if(boat.angle<-2){
            boat.angle=-2;
        }
        
        //Actualize positions
        //Of the boat
        boat.posY-=boat.angle;
        //make sure position is allowed
        if(boat.posY < 16){
            boat.posY=16;
        }
        else if(boat.posY > 47){
            boat.posY=47;
        }
        
        //Of the rocks
        for(i=0;i<ROCKS_NB;i++){
            if(rocks[i].posX>-6)rocks[i].posX-=2;
            else(rocks[i]=initRock());
        }
        
        //Check collision 
        for(i=0;i<ROCKS_NB;i++){
            if(((rocks[i].posX-BOAT_POSX)<8)&&(rocks[i].posX-BOAT_POSX>-8)&&((boat.posY/8)==rocks[i].posY)){
                game_over=1;
            }
        }
        
        //DISPLAY
        glcd_FillRiver();
        
        sprintf(scorestr, "=%d", score);
        glcd_SetCursor(64,7);
        glcd_WriteString(scorestr, f8X8, 1);
        
        for(i=0; i<ROCKS_NB; i++){
            glcd_WriteRock(rocks[i].posX, rocks[i].posY);
        }
        
        glcd_PlotPixel(BOAT_POSX, boat.posY, 1);
        
        nb=score%13+score;
        score++;
        //Wait a little
        wait(500);
        
    }
    while(1);
    
}

void scores();
void help();


void menu(){
    unsigned char s=0;
    while(!PORTAbits.RA0){
        if(PORTAbits.RA1){ //Left button
            if(s<2)s++;
        }
        if(PORTAbits.RA2){ //Right button
            if(s>0)s--;
        }
    }
    switch(s){
        case 0: 
            play();
            break;
        case 1: 
            //scores();
            break;
        case 2:
            //help();
            break;
        default:
            play();
    }
}

void main(void) {
    initMyPIC18F();
    glcd_Init(GLCD_ON);
    
    play();
    
    //menu();
    return;
}



